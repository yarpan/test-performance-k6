import { check, sleep } from "k6";
import http from "k6/http";
import { Options } from "k6/options";

/**
 * STRESS –¢–ï–°–¢–£–í–ê–ù–ù–Ø (–°—Ç—Ä–µ—Å-—Ç–µ—Å—Ç)
 *
 * –ú–µ—Ç–∞: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ–≤–µ–¥—ñ–Ω–∫—É —Å–∏—Å—Ç–µ–º–∏ –ø—Ä–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ
 *
 * –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:
 * - –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç—ñ–≤ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
 * - –î–ª—è –æ—Ü—ñ–Ω–∫–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü—ñ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–æ–º—É –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
 * - –î–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è, —á–∏ –≤–∏—Ç—Ä–∏–º—É—î —Å–∏—Å—Ç–µ–º–∞ –ø—ñ–∫–æ–≤—ñ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
 *
 * –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
 * - –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ 50-100% –≤–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ (200 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø—Ä–æ—Ç–∏ 100 —É avg-load)
 * - –î–æ–≤—à–∏–π –ø–µ—Ä—ñ–æ–¥ –Ω–∞—Ä–æ—â—É–≤–∞–Ω–Ω—è –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (10 —Ö–≤–∏–ª–∏–Ω)
 * - –¢—Ä–∏–≤–∞–ª–µ –ø—ñ–¥—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—ñ–∫–æ–≤–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (30 —Ö–≤–∏–ª–∏–Ω)
 * - –û—á—ñ–∫—É—î—Ç—å—Å—è –ø–æ–≥—ñ—Ä—à–µ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ —ñ–∑ —Å–µ—Ä–µ–¥–Ω—ñ–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
 * - –ü–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∏ –ø—Ä–∏ —Å—Ç—Ä–µ—Å–æ–≤–æ–º—É –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
 */
export const options: Options = {
  cloud: {
    stages: [
      { duration: "10m", target: 200 }, // –ø–æ–≤—ñ–ª—å–Ω–µ –Ω–∞—Ä–æ—â—É–≤–∞–Ω–Ω—è –¥–æ —Å—Ç—Ä–µ—Å–æ–≤–æ–≥–æ —Ä—ñ–≤–Ω—è
      { duration: "30m", target: 200 }, // –ø—ñ–¥—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç—Ä–µ—Å–æ–≤–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
      { duration: "5m", target: 0 }, // —à–≤–∏–¥–∫–µ –∑–Ω–∏–∂–µ–Ω–Ω—è –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    ],
    distribution: {
      "amazon:de:frankfurt": { loadZone: "amazon:de:frankfurt", percent: 100 },
    },
    projectID: 4087876,
    name: "Pizza Stress Test - –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥–≤–∏—â–µ–Ω–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è",
  },
};

export function setup() {
  const response = http.post(
    "https://quickpizza.grafana.com/api/users/token/login",
    JSON.stringify({
      username: "default",
      password: "12345678",
    }),
    {
      headers: { "Content-Type": "application/json" },
    }
  );

  // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∏ –¥–æ —Å—Ç—Ä–µ—Å-—Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
  const authSuccess = check(response, {
    "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –¥–ª—è —Å—Ç—Ä–µ—Å-—Ç–µ—Å—Ç—É": (r) => r.status === 200,
    "üîê –¢–æ–∫–µ–Ω –æ—Ç—Ä–∏–º–∞–Ω–æ": (r) => !!r.json("token"),
  });

  const json = response.json();
  const token = json!["token"];

  return { token };
}

export default function ({ token }) {
  // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—ñ—Ü–∏ –ø—ñ–¥ –≤–∏—Å–æ–∫–∏–º –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
  const response = http.post(
    "https://quickpizza.grafana.com/api/pizza",
    JSON.stringify({
      maxCaloriesPerSlice: 1000,
      mustBeVegetarian: false,
      excludedIngredients: [],
      excludedTools: [],
      maxNumberOfToppings: 5,
      minNumberOfToppings: 2,
    }),
    {
      headers: {
        authorization: `Token ${token}`,
        "Content-Type": "application/json",
      },
    }
  );

  check(response, {
    "–ó–∞–ø–∏—Ç –≤–∏–∫–æ–Ω–∞–Ω–æ –ø—Ä–∏ —Å—Ç—Ä–µ—Å—ñ": (r) => r.status === 200,
    "–ß–∞—Å –≤—ñ–¥–≥—É–∫—É –ø—ñ–¥ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º": (r) => r.timings.duration < 800,
    "–°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞—î": (r) => r.status !== 500 && r.status !== 503,
  });

  // –ù–µ–≤–µ–ª–∏–∫–∞ –ø–∞—É–∑–∞ –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏ –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó —Ä–µ–∞–ª—å–Ω–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  sleep(Math.random() * 2 + 1); // –≤–∏–ø–∞–¥–∫–æ–≤–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ 1-3 —Å–µ–∫—É–Ω–¥–∏
}